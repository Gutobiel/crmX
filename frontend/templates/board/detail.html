{% extends 'base.html' %}
{% load static %}

{% block title %}{{ board.nome }} - Pasta{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <style>
        .board-breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #666;
            font-size: 14px;
        }

        .board-breadcrumb a {
            color: #333781;
            text-decoration: none;
        }

        .board-breadcrumb a:hover {
            text-decoration: underline;
        }

        .board-info-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .board-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .board-title {
            color: #302754;
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }

        .board-actions {
            display: flex;
            gap: 10px;
        }

        .board-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .meta-label {
            color: #666;
            font-size: 14px;
        }

        .meta-value {
            color: #302754;
            font-size: 16px;
            font-weight: 600;
        }

        .sheets-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            color: #302754;
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .sheets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .sheet-card {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sheet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #333781;
        }

        .sheet-name {
            color: #302754;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .sheet-name i {
            margin-right: 8px;
            color: #333781;
        }

        .sheet-info {
            color: #666;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .sheet-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .sheet-info i {
            width: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .sheet-wrapper {
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 25px;
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e5e9;
        }

        .sheet-header h3 {
            color: #302754;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sheet-actions {
            display: flex;
            gap: 10px;
        }

        .btn-sheet-action {
            padding: 8px 16px;
            background: white;
            color: #333781;
            border: 1px solid #333781;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-sheet-action:hover {
            background: #333781;
            color: white;
        }

        .editable-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .editable-table th, .editable-table td {
            border: 1px solid #e1e5e9;
            padding: 12px 15px;
            min-width: 120px;
            text-align: left;
        }

        .editable-table th {
            background: #f8f9fa;
            color: #302754;
            font-weight: 600;
            font-size: 13px;
        }

        .editable-table td[contenteditable="true"], .editable-table th[contenteditable="true"] {
            cursor: text;
            transition: background 0.2s ease;
        }

        .editable-table td[contenteditable="true"]:hover {
            background: #f8f9fa;
        }

        .editable-table td[contenteditable="true"]:focus {
            outline: 2px solid #333781;
            outline-offset: -2px;
            background: white;
        }

        .action-cell {
            width: 80px;
            text-align: center;
            background: #f8f9fa;
        }

        .btn-delete-row {
            padding: 4px 8px;
            background: none;
            color: #dc3545;
            border: 1px solid #dc3545;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn-delete-row:hover {
            background: #dc3545;
            color: white;
        }

        .table-footer {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        /* Inline editable styles (padr√£o claro) */
        .table-toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn-sheet-secondary {
            padding: 8px 12px;
            background: white;
            color: #333781;
            border: 1px solid #e1e5e9;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-sheet-secondary:hover {
            background: #f8f9fa;
            border-color: #333781;
            color: #333781;
        }

        .editable-wrapper {
            display: inline-block;
            width: 100%;
            min-height: 20px;
            padding: 4px 6px;
            cursor: text;
            background: transparent;
            color: #302754;
            border: 1px solid transparent;
            border-radius: 3px;
            box-sizing: border-box;
        }

        .editable-wrapper:focus {
            outline: none;
            border-color: #333781;
            background: #fff;
        }

        /* Estilos para sub-linhas */
        .sub-row {
            background-color: #fafafa;
        }

        .sub-row td {
            padding-left: 40px;
            font-size: 0.95em;
            border-left: 3px solid #333781;
        }

        .main-row {
            background-color: white;
        }

        .add-sub-btn {
            padding: 6px 12px;
            background-color: #28a745;
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .add-sub-btn:hover {
            background-color: #1e7e34;
        }

        .remove-btn {
            padding: 6px 12px;
            background-color: #dc3545;
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .remove-btn:hover {
            background-color: #b02a37;
        }

        .action-cell {
            display: flex;
            gap: 5px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .editable-table td[contenteditable="true"],
        .editable-table th[contenteditable="true"] {
            background-color: #fffdf2;
            transition: background-color 0.3s;
        }

        .editable-table td[contenteditable="true"]:focus,
        .editable-table th[contenteditable="true"]:focus {
            background-color: #ffffcc;
            outline: 2px solid #333781;
            outline-offset: -2px;
        }

    </style>
{% endblock %}

{% block page_title %}
    {{ board.nome }}
{% endblock %}

{% block breadcrumb %}
    <div class="board-breadcrumb">
        <a href="{% url 'workspace' %}"><i class="fas fa-home"></i> Workspaces</a>
        <i class="fas fa-chevron-right"></i>
        <a href="{% url 'workspace_detail' workspace.id %}">{{ workspace.nome }}</a>
        <i class="fas fa-chevron-right"></i>
        <span>{{ board.nome }}</span>
    </div>
{% endblock %}

{% block content %}
    <!-- Board Info -->
    <div class="board-info-card">
        <div class="board-title-section">
            <h1 class="board-title">{{ board.nome }}</h1>
            <div class="board-actions">
                <button class="btn-action" onclick="editBoard()">
                    <i class="fas fa-edit"></i>
                    Editar
                </button>
                <button class="btn-action" onclick="shareBoard()">
                    <i class="fas fa-share-alt"></i>
                    Compartilhar
                </button>
                <button class="btn-action" style="color: #dc3545;" onclick="deleteBoard()">
                    <i class="fas fa-trash"></i>
                    Excluir
                </button>
            </div>
        </div>

        <div class="board-meta">
            <div class="meta-item">
                <span class="meta-label">Workspace</span>
                <span class="meta-value">{{ workspace.nome }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Criado em</span>
                <span class="meta-value">{{ board.created_at|date:'d/m/Y H:i' }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">√öltima atualiza√ß√£o</span>
                <span class="meta-value">{{ board.updated_at|date:'d/m/Y H:i' }}</span>
            </div>
        </div>
    </div>

    <!-- Sheets Section -->
    <div class="sheets-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-table"></i> Planilhas
            </h2>
            <a class="btn-primary" href="/sheet/new/?board={{ board.id }}" id="btnNewSheet">
                <i class="fas fa-plus"></i>
                Nova Planilha
            </a>
        </div>
    <!-- Planilhas
     - Nome da planilha e planilha
      -->

        <div id="sheetsContainer" class="space-y-8"></div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Fun√ß√µes globais (fora do m√≥dulo para acessar via onclick)
    window.openSheet = function(sheetId) {
        console.log('Opening sheet:', sheetId);
        window.location.href = `/sheet/${sheetId}/`;
    };

    window.createSheet = function() {
        const boardId = {{ board.id }};
        window.location.assign(`/sheet/new/?board=${boardId}`);
    };

    window.editBoard = function() {
        alert('Funcionalidade de edi√ß√£o ser√° implementada');
    };

    window.shareBoard = function() {
        alert('Funcionalidade de compartilhamento ser√° implementada');
    };

    window.deleteBoard = async function() {
        const workspaceId = {{ workspace.id }};
        const boardId = {{ board.id }};
        
        if (!confirm('Tem certeza que deseja excluir esta pasta? Esta a√ß√£o n√£o pode ser desfeita.')) {
            return;
        }

        try {
            const { getAuthHeaders } = await import('{% static "js/api/auth.js" %}');
            const headers = await getAuthHeaders();
            const response = await fetch(`/api/v1/board/${boardId}/`, {
                method: 'DELETE',
                headers
            });

            if (!response.ok) throw new Error('Failed to delete board');

            alert('Pasta exclu√≠da com sucesso!');
            window.location.href = `/workspace/${workspaceId}/boards/`;
        } catch (error) {
            console.error('Error deleting board:', error);
            alert('Erro ao excluir pasta');
        }
    };
</script>

<script type="module">
import axios from "https://cdn.jsdelivr.net/npm/axios@1.6.2/+esm";
import { getAuthHeaders } from "{% static 'js/api/auth.js' %}";

const boardId = {{ board.id }};
const headers = await getAuthHeaders();
const api = axios.create({ headers });

// ============================================================
//  üîπ Fun√ß√µes de comunica√ß√£o com o backend (Django REST)
// ============================================================

async function getSheets() {
  const { data } = await api.get(`/api/v1/sheet/?board=${boardId}`);
  return Promise.all(data.map(async sheet => {
    const detail = await api.get(`/api/v1/sheet/${sheet.id}/`);
    return detail.data;
  }));
}

async function updateCell(cellId, newValue) {
  try {
    await api.patch(`/api/v1/cell/${cellId}/`, { value: newValue });
  } catch (err) {
    console.error(`Erro ao atualizar c√©lula ${cellId}:`, err);
  }
}

async function updateColumn(colId, newName) {
  try {
    await api.patch(`/api/v1/column/${colId}/`, { nome: newName });
  } catch (err) {
    console.error(`Erro ao atualizar coluna ${colId}:`, err);
  }
}

async function addRow(sheetId, parentId = null, isSubrow = false) {
  const { data } = await api.post(`/api/v1/row/`, {
    sheet: sheetId,
    parent: parentId,
    is_subrow: isSubrow,
  });
  return data;
}

async function deleteRow(rowId) {
  await api.delete(`/api/v1/row/${rowId}/`);
}

// ============================================================
//  üîπ Renderiza√ß√£o de tabela
// ============================================================

function renderSheetCard(sheet) {
  const columns = sheet.columns || [];
  const rows = sheet.rows || [];

  const table = document.createElement("table");
  table.className = "dynamic-table w-full border border-gray-300 rounded-lg shadow-sm";

  // Cabe√ßalho
  const thead = document.createElement("thead");
  thead.innerHTML = `
    <tr class="bg-gray-100">
      ${columns.map(c => `<th data-col-id="${c.id}" class="p-2 border">${c.nome}</th>`).join("")}
      <th class="p-2 border">A√ß√µes</th>
    </tr>`;
  table.appendChild(thead);

  // Corpo
  const tbody = document.createElement("tbody");

  rows.filter(r => !r.is_subrow).forEach(row => {
    tbody.appendChild(renderRow(row, columns, sheet.id, rows));
  });

  table.appendChild(tbody);

  // Bot√£o adicionar linha
  const addLineBtn = document.createElement("button");
  addLineBtn.className = "mt-2 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700";
  addLineBtn.textContent = "Adicionar linha";
  addLineBtn.onclick = async () => {
    const newRow = await addRow(sheet.id);
    const rowEl = renderRow(newRow, columns, sheet.id, rows);
    tbody.appendChild(rowEl);
    enableLiveEditing(rowEl.closest("table"));
  };

  const container = document.createElement("div");
  container.innerHTML = `<h3 class="text-lg font-semibold mb-2">${sheet.nome}</h3>`;
  container.appendChild(table);
  container.appendChild(addLineBtn);

  return container.outerHTML;
}

function renderRow(row, columns, sheetId, allRows) {
  const tr = document.createElement("tr");
  tr.dataset.rowId = row.id;

  const cells = row.cells || [];

  // C√©lulas principais
  columns.forEach(col => {
    const cell = cells.find(c => c.column === col.id);
    const td = document.createElement("td");
    td.className = "p-2 border";
    td.dataset.cellId = cell?.id;
    td.contentEditable = true;
    td.textContent = cell?.value || "";
    td.addEventListener("blur", async e => {
      const newValue = e.target.innerText.trim();
      if (cell) await updateCell(cell.id, newValue);
    });
    tr.appendChild(td);
  });

  // Coluna de a√ß√µes
  const tdActions = document.createElement("td");
  tdActions.className = "p-2 border text-center";

  const addSubBtn = document.createElement("button");
  addSubBtn.textContent = "‚ûï Sublinha";
  addSubBtn.className = "text-blue-600 mr-2";
  addSubBtn.onclick = async () => {
    const newSub = await addRow(sheetId, row.id, true);
    const subEl = renderRow(newSub, columns, sheetId, allRows);
    subEl.classList.add("bg-gray-50");
    tr.insertAdjacentElement("afterend", subEl);
    enableLiveEditing(tr.closest("table"));
  };

  const delBtn = document.createElement("button");
  delBtn.textContent = "üóëÔ∏è";
  delBtn.className = "text-red-600";
  delBtn.onclick = async () => {
    await deleteRow(row.id);
    tr.remove();
  };

  tdActions.appendChild(addSubBtn);
  tdActions.appendChild(delBtn);
  tr.appendChild(tdActions);

  return tr;
}

// ============================================================
//  üîπ Edi√ß√£o ao vivo (colunas + c√©lulas)
// ============================================================

function enableLiveEditing(tableEl) {
  // Editar nome de coluna
  tableEl.querySelectorAll("th[data-col-id]").forEach(th => {
    th.contentEditable = true;
    th.addEventListener("blur", async e => {
      const colId = e.target.dataset.colId;
      const newName = e.target.innerText.trim();
      await updateColumn(colId, newName);
    });
  });

  // Editar c√©lula
  tableEl.querySelectorAll("td[data-cell-id]").forEach(td => {
    td.contentEditable = true;
    td.addEventListener("blur", async e => {
      const cellId = e.target.dataset.cellId;
      const newValue = e.target.innerText.trim();
      await updateCell(cellId, newValue);
    });
  });
}

// ============================================================
//  üîπ Inicializa√ß√£o
// ============================================================

(async function init() {
  document.getElementById("sheetsContainer").innerHTML = `
    <div class="text-center text-gray-500">
      <i class="fas fa-spinner fa-spin mr-2"></i>Carregando planilhas...
    </div>`;

  const sheets = await getSheets();

  const container = document.getElementById("sheetsContainer");
  container.innerHTML = sheets.map(renderSheetCard).join("");

  // ativa edi√ß√£o ao vivo em todas as tabelas
  container.querySelectorAll(".dynamic-table").forEach(enableLiveEditing);
})();
</script>
{% endblock %}
