{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <style>
        .sheet-breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #666;
            font-size: 14px;
        }

        .sheet-breadcrumb a {
            color: #333781;
            text-decoration: none;
        }

        .sheet-breadcrumb a:hover {
            text-decoration: underline;
        }

        .sheet-header {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .sheet-title-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sheet-title {
            color: #302754;
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }

        .sheet-type-badge {
            padding: 6px 12px;
            background: rgba(51,55,129,0.1);
            color: #333781;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 600;
            width: fit-content;
        }

        .sheet-description {
            margin: 0;
            color: #555;
            font-size: 14px;
        }

        .sheet-context {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            color: #666;
            font-size: 14px;
        }

        .sheet-context strong {
            color: #302754;
        }

        .sheet-data-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 24px;
            margin-bottom: 24px;
        }

        .sheet-data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .sheet-data-header h2 {
            margin: 0;
            font-size: 20px;
            color: #302754;
            font-weight: 600;
        }

        .sheet-data-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-sheet-inline {
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid #333781;
            background: #333781;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-sheet-inline:hover {
            background: #252d6e;
        }

        .sheet-data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .sheet-data-table th,
        .sheet-data-table td {
            border: 1px solid #e5e9f2;
            padding: 10px 12px;
            text-align: left;
            font-size: 14px;
            vertical-align: top;
        }

        .sheet-data-table th {
            background-color: #f0f1f7;
            color: #302754;
            font-weight: 600;
        }

        .sheet-data-table tbody tr:nth-child(even) {
            background-color: #fafbff;
        }

        .column-editable {
            display: block;
            width: 100%;
        }

        .column-editable[contenteditable="true"] {
            cursor: text;
            background-color: #fffdf2;
        }

        .column-editable[contenteditable="true"]:focus {
            outline: none;
            background-color: #ffffcc;
        }

        .sheet-row--sub td.sheet-cell:first-child {
            padding-left: 32px;
        }

        .sheet-cell-actions {
            white-space: nowrap;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            width: 200px;
        }

        .sheet-cell-actions .btn-sheet-inline {
            background: transparent;
            color: #333781;
        }

        .sheet-cell-actions .btn-sheet-inline:hover {
            background: #333781;
            color: #fff;
        }

        .sheet-empty-cell {
            text-align: center;
            padding: 30px 0;
            color: #666;
            font-style: italic;
        }

        .contracts-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 24px;
        }

        .contracts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .contracts-header h2 {
            margin: 0;
            font-size: 20px;
            color: #302754;
            font-weight: 600;
        }

        .btn-primary {
            padding: 10px 18px;
            background-color: #333781;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .btn-primary:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #242955;
        }

        .add-form {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fc;
            border: 1px solid #d1d9e6;
            border-radius: 10px;
            display: none;
        }

        .add-form.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #302754;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccd5e0;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn-secondary {
            padding: 10px 18px;
            background-color: #6c757d;
            border: none;
            color: white;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .contracts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .contracts-table th,
        .contracts-table td {
            border: 1px solid #e5e9f2;
            padding: 12px 14px;
            text-align: left;
            font-size: 14px;
        }

        .contracts-table th {
            background-color: #333781;
            color: white;
            font-weight: 600;
        }

        .contracts-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .contracts-actions .btn-secondary {
            padding: 6px 12px;
            font-size: 12px;
        }

        .editable-wrapper {
            display: block;
            width: 100%;
            min-height: 20px;
            padding: 4px 6px;
            cursor: text;
            background-color: #fffdf2;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .editable-wrapper:focus {
            outline: none;
            background-color: #ffffcc;
        }

        .editable-wrapper.cell-saving {
            background-color: rgba(51,55,129,0.15);
        }

        .editable-wrapper.cell-error {
            background-color: rgba(220,53,69,0.2);
        }

        .form-errors {
            margin-top: 10px;
            color: #dc3545;
            font-weight: 600;
        }

        .table-wrapper {
            overflow-x: auto;
        }
    </style>
{% endblock %}

{% block page_title %}
    {{ sheet.nome }}
{% endblock %}

{% block breadcrumb %}
    <div class="sheet-breadcrumb">
        <a href="{% url 'workspace' %}"><i class="fas fa-home"></i> Workspaces</a>
        {% if workspace %}
            <i class="fas fa-chevron-right"></i>
            <a href="{% url 'workspace_detail' workspace.id %}">{{ workspace.nome }}</a>
        {% endif %}
        {% if board %}
            <i class="fas fa-chevron-right"></i>
            <a href="{% url 'board_detail' board.workspace.id board.id %}">{{ board.nome }}</a>
        {% endif %}
        <i class="fas fa-chevron-right"></i>
        <span>{{ sheet.nome }}</span>
    </div>
{% endblock %}

{% block content %}
    <div class="sheet-header">
        <div class="header-top">
            <div class="sheet-title-wrapper">
                <h1 class="sheet-title">{{ sheet.nome }}</h1>
                <span class="sheet-type-badge">{{ sheet.get_tipo_display }}</span>
                {% if sheet.descricao %}
                    <p class="sheet-description">{{ sheet.descricao }}</p>
                {% endif %}
                <div class="sheet-context">
                    <span><strong>Pasta:</strong> {{ board.nome }}</span>
                      <span><strong>Area de trabalho:</strong> {{ workspace.nome }}</span>
                </div>
            </div>
        </div>
    </div>

    <section class="sheet-data-section">
        <div class="sheet-data-header">
            <h2>Dados da planilha</h2>
            <div class="sheet-data-actions">
                <button type="button" class="btn-sheet-inline" id="btnAddRow">
                    <i class="fas fa-plus"></i> Adicionar linha
                </button>
                {% if sheet.template_type == 'generico' %}
                    <button type="button" class="btn-sheet-inline" id="btnAddColumn">
                        <i class="fas fa-columns"></i> Adicionar coluna
                    </button>
                {% endif %}
            </div>
        </div>

        {% if columns %}
            <div class="table-wrapper">
                <table class="sheet-data-table" data-columns-count="{{ sheet_columns_count }}">
                    <thead>
                        <tr>
                            {% for column in columns %}
                                <th>
                                    <span
                                        class="column-editable editable-wrapper"
                                        contenteditable="{{ column.editavel|yesno:'true,false' }}"
                                        data-column-id="{{ column.id }}"
                                        data-editable="{{ column.editavel|yesno:'true,false' }}"
                                        data-value="{{ column.nome|default_if_none:'' }}">
                                        {{ column.nome|default:'(Sem nome)' }}
                                    </span>
                                </th>
                            {% endfor %}
                            <th class="sheet-actions-header">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if sheet_rows %}
                            {% for row in sheet_rows %}
                                {% include 'sheet/_row.html' with row=row %}
                            {% endfor %}
                        {% else %}
                            <tr class="sheet-empty-row" data-placeholder-row="true">
                                <td colspan="{{ sheet_columns_count|add:1 }}" class="sheet-empty-cell">
                                    Nenhuma linha cadastrada.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="sheet-empty-cell" style="border: 1px dashed #d7dcf0; border-radius: 12px;">
                <i class="fas fa-columns" style="font-size: 36px; display: block; margin-bottom: 10px;"></i>
                Nenhuma coluna configurada para esta planilha.
            </div>
        {% endif %}
    </section>

    {% if sheet.template_type == 'contratos' %}
    <section class="contracts-section">
        <div class="contracts-header">
            <h2>Contratos vinculados</h2>
            <button type="button" class="btn-primary" id="toggleAddContract" aria-expanded="{% if form.errors %}true{% else %}false{% endif %}"{% if not can_add_contrato %} disabled{% endif %}>
                Adicionar contrato
            </button>
        </div>

        {% if not can_add_contrato %}
            <p class="form-errors">Crie ou selecione uma pasta/planilha para conseguir adicionar um novo contrato.</p>
        {% endif %}

        <div id="addContractWrapper" class="add-form{% if form.errors %} active{% endif %}">
            <form method="post" novalidate>
                {% csrf_token %}
                {% if form.non_field_errors %}
                    <div class="form-errors">{{ form.non_field_errors }}</div>
                {% endif %}
                <div class="form-grid">
                    {% if show_board_field %}
                        <div class="form-group">
                            <label for="{{ form.board.id_for_label }}">Pasta</label>
                            {{ form.board }}
                            {{ form.board.errors }}
                        </div>
                    {% else %}
                        <div style="display:none;">
                            {{ form.board }}
                        </div>
                        {{ form.board.errors }}
                    {% endif %}

                    {% if show_sheet_field %}
                        <div class="form-group">
                            <label for="{{ form.sheet.id_for_label }}">Planilha</label>
                            {{ form.sheet }}
                            {{ form.sheet.errors }}
                        </div>
                    {% else %}
                        <div style="display:none;">
                            {{ form.sheet }}
                        </div>
                        {{ form.sheet.errors }}
                    {% endif %}

                    <div class="form-group">
                        <label for="{{ form.elemento.id_for_label }}">Elemento</label>
                        {{ form.elemento }}
                        {{ form.elemento.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.empresa.id_for_label }}">Empresa</label>
                        {{ form.empresa }}
                        {{ form.empresa.errors }}
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label for="{{ form.objeto.id_for_label }}">Objeto</label>
                        {{ form.objeto }}
                        {{ form.objeto.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.qtd_total_itens.id_for_label }}">Qtd. total itens</label>
                        {{ form.qtd_total_itens }}
                        {{ form.qtd_total_itens.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.valor_total_anterior.id_for_label }}">Valor total anterior</label>
                        {{ form.valor_total_anterior }}
                        {{ form.valor_total_anterior.errors }}
                    </div>
                    <div class="form-group">
                        <label for="{{ form.valor_total_reajustado.id_for_label }}">Valor total reajustado</label>
                        {{ form.valor_total_reajustado }}
                        {{ form.valor_total_reajustado.errors }}
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelAddContract">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>

        <div class="table-wrapper">
            <table class="contracts-table">
                <thead>
                    <tr>
                        <th>Elemento</th>
                        <th>Empresa</th>
                        <th>Objeto</th>
                        <th>Qtd. total itens</th>
                        <th>Valor total anterior</th>
                        <th>Valor total reajustado</th>
                        <th width="220">Acoes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for contrato in contratos %}
                        <tr data-contrato-id="{{ contrato.id }}">
                            <td class="editable-wrapper" contenteditable="true" data-field="elemento" data-type="text" data-value="{{ contrato.elemento|default_if_none:'' }}">{{ contrato.elemento|default:'-' }}</td>
                            <td class="editable-wrapper" contenteditable="true" data-field="empresa" data-type="text" data-value="{{ contrato.empresa|default_if_none:'' }}">{{ contrato.empresa|default:'-' }}</td>
                            <td class="editable-wrapper" contenteditable="true" data-field="objeto" data-type="text" data-value="{{ contrato.objeto|default_if_none:'' }}">{{ contrato.objeto|default:'-' }}</td>
                            <td class="editable-wrapper" contenteditable="true" data-field="qtd_total_itens" data-type="integer" data-value="{{ contrato.qtd_total_itens|default_if_none:0 }}">{{ contrato.qtd_total_itens|default:'-' }}</td>
                            <td class="editable-wrapper" contenteditable="true" data-field="valor_total_anterior" data-type="currency" data-value="{{ contrato.valor_total_anterior|default_if_none:0 }}">R$ {{ contrato.valor_total_anterior|default_if_none:0|floatformat:2 }}</td>
                            <td class="editable-wrapper" contenteditable="true" data-field="valor_total_reajustado" data-type="currency" data-value="{{ contrato.valor_total_reajustado|default_if_none:0 }}">R$ {{ contrato.valor_total_reajustado|default_if_none:0|floatformat:2 }}</td>
                            <td class="contracts-actions">
                                <button type="button" class="btn-secondary" title="Adicionar sublinha" disabled>Adicionar sublinha</button>
                                <button type="button" class="btn-secondary" title="Excluir" disabled>Excluir</button>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="7" style="text-align: center;">Nenhum contrato encontrado.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script type="module">
    import { getAuthHeaders } from '{% static "js/api/auth.js" %}';

    const sheetId = Number('{{ sheet.id }}');
    const sheetTipo = '{{ sheet.template_type|escapejs }}';
    const SHEET_API_BASE = `/api/v1/sheets/${sheetId}/`;
    const CONTRACTS_API_BASE = '/api/v1/contratos/';

    const initSheetSection = () => {
        const addRowBtn = document.getElementById('btnAddRow');
        const addColumnBtn = document.getElementById('btnAddColumn');

        async function handleAddColumn() {
            if (!addColumnBtn || addColumnBtn.disabled) {
                return;
            }

            const nome = window.prompt('Informe o nome da nova coluna:', 'Nova coluna');
            if (nome === null) {
                return;
            }
            const trimmed = nome.trim();
            if (!trimmed) {
                window.alert('O nome da coluna não pode ficar vazio.');
                return;
            }

            addColumnBtn.disabled = true;
            try {
                const headers = await getAuthHeaders();
                headers['Content-Type'] = 'application/json';

                const response = await fetch(`${SHEET_API_BASE}add_column/`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ nome: trimmed })
                });

                if (!response.ok) {
                    const detail = await response.text();
                    throw new Error(detail || `Erro ao adicionar coluna (status ${response.status})`);
                }

                window.location.reload();
            } catch (error) {
                console.error('add_column error', error);
                window.alert(error.message || 'Erro ao adicionar coluna.');
                addColumnBtn.disabled = false;
            }
        }

        if (addColumnBtn) {
            addColumnBtn.addEventListener('click', handleAddColumn);
        }

        const table = document.querySelector('.sheet-data-table');
        if (!table) {
            if (addRowBtn) {
                addRowBtn.disabled = true;
            }
            return;
        }

        const tbody = table.querySelector('tbody');
        const state = { columns: [] };

        const updateColumnsMeta = () => {
            state.columns = Array.from(table.querySelectorAll('thead .column-editable')).map((element, index) => ({
                id: Number(element.dataset.columnId),
                editable: element.dataset.editable === 'true',
                element,
                index,
            }));
        };

        updateColumnsMeta();

        const applyCellValue = (cell, value) => {
            const normalized = value != null ? String(value).trim() : '';
            cell.dataset.value = normalized;
            cell.textContent = normalized === '' ? '-' : normalized;
        };

        const removePlaceholderRow = () => {
            if (!tbody) {
                return;
            }
            const placeholder = tbody.querySelector('tr.sheet-empty-row');
            if (placeholder) {
                placeholder.remove();
            }
        };

        const ensurePlaceholderRow = () => {
            if (!tbody) {
                return;
            }
            const hasDataRow = tbody.querySelector('tr.sheet-row');
            if (hasDataRow) {
                return;
            }
            const existing = tbody.querySelector('tr.sheet-empty-row');
            if (existing) {
                return;
            }
            const tr = document.createElement('tr');
            tr.classList.add('sheet-empty-row');
            tr.dataset.placeholderRow = 'true';

            const td = document.createElement('td');
            td.classList.add('sheet-empty-cell');
            const colSpan = Math.max(state.columns.length + 1, 1);
            td.colSpan = colSpan;
            td.textContent = 'Nenhuma linha cadastrada.';

            tr.appendChild(td);
            tbody.appendChild(tr);
        };

        const createActionButton = (className, iconClass, label, rowId) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = `btn-sheet-inline ${className}`;
            button.dataset.rowId = String(rowId);
            button.innerHTML = `<i class="${iconClass}"></i> ${label}`;
            return button;
        };

        const createRowElement = (rowId, { isSubrow = false, parentId = null } = {}) => {
            const tr = document.createElement('tr');
            tr.classList.add('sheet-row');
            if (isSubrow) {
                tr.classList.add('sheet-row--sub');
            }
            tr.dataset.rowId = String(rowId);
            if (parentId) {
                tr.dataset.parentId = String(parentId);
            }

            state.columns.forEach(({ id }) => {
                const td = document.createElement('td');
                td.classList.add('editable-wrapper', 'sheet-cell');
                td.setAttribute('contenteditable', 'true');
                td.dataset.rowId = String(rowId);
                td.dataset.columnId = String(id);
                td.dataset.value = '';
                td.textContent = '-';
                tr.appendChild(td);
            });

            const actions = document.createElement('td');
            actions.classList.add('sheet-cell-actions');
            if (!isSubrow) {
                const addSub = createActionButton('btn-add-subrow', 'fas fa-level-down-alt', 'Sub-linha', rowId);
                actions.appendChild(addSub);
            }
            const removeBtn = createActionButton('btn-delete-row', 'fas fa-trash', 'Excluir', rowId);
            actions.appendChild(removeBtn);
            tr.appendChild(actions);

            return tr;
        };

        const insertRowElement = (rowElement, parentId = null) => {
            if (!tbody) {
                return;
            }
            removePlaceholderRow();

            if (!parentId) {
                tbody.appendChild(rowElement);
                return;
            }

            const siblings = Array.from(tbody.querySelectorAll(`tr.sheet-row[data-parent-id="${parentId}"]`));
            if (siblings.length > 0) {
                siblings[siblings.length - 1].after(rowElement);
                return;
            }

            const parentRow = tbody.querySelector(`tr.sheet-row[data-row-id="${parentId}"]`);
            if (parentRow) {
                parentRow.after(rowElement);
                return;
            }

            tbody.appendChild(rowElement);
        };

        const removeRowAndDescendants = (rowId) => {
            if (!tbody) {
                return;
            }
            const toRemove = new Set([String(rowId)]);
            let added;

            do {
                added = false;
                tbody.querySelectorAll('tr.sheet-row').forEach((row) => {
                    const parentId = row.dataset.parentId;
                    if (parentId && toRemove.has(parentId) && !toRemove.has(row.dataset.rowId)) {
                        toRemove.add(row.dataset.rowId);
                        added = true;
                    }
                });
            } while (added);

            toRemove.forEach((id) => {
                const row = tbody.querySelector(`tr.sheet-row[data-row-id="${id}"]`);
                if (row) {
                    row.remove();
                }
            });

            ensurePlaceholderRow();
        };

        const handleCellFocus = (event) => {
            const cell = event.target.closest('.sheet-cell');
            if (!cell) {
                return;
            }
            const currentValue = cell.dataset.value ?? '';
            cell.dataset.originalValue = currentValue;
            if (currentValue === '') {
                cell.textContent = '';
            }
        };

        const handleCellKeyDown = (event) => {
            const cell = event.target.closest('.sheet-cell');
            if (!cell) {
                return;
            }
            if (event.key === 'Enter') {
                event.preventDefault();
                cell.blur();
            }
        };

        const handleCellBlur = (event) => {
            const cell = event.target.closest('.sheet-cell');
            if (!cell) {
                return;
            }

            const rowId = Number(cell.dataset.rowId);
            const columnId = Number(cell.dataset.columnId);
            if (!rowId || !columnId) {
                return;
            }

            const newValue = cell.textContent.trim();
            const originalValue = (cell.dataset.originalValue ?? '').trim();
            delete cell.dataset.originalValue;

            if (newValue === originalValue) {
                applyCellValue(cell, cell.dataset.value ?? '');
                return;
            }

            saveCellValue(cell, newValue);
        };

        const saveCellValue = async (cell, value) => {
            const rowId = Number(cell.dataset.rowId);
            const columnId = Number(cell.dataset.columnId);
            const payload = {
                row_id: rowId,
                column_id: columnId,
                value,
            };

            if (cell.dataset.cellId) {
                payload.cell_id = Number(cell.dataset.cellId);
            }

            cell.classList.add('cell-saving');
            try {
                const headers = await getAuthHeaders();
                headers['Content-Type'] = 'application/json';

                const response = await fetch(`${SHEET_API_BASE}update_cell/`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    const detail = await response.text();
                    throw new Error(detail || `Erro ao salvar célula (status ${response.status})`);
                }

                const data = await response.json().catch(() => ({}));
                if (data && data.cell_id) {
                    cell.dataset.cellId = String(data.cell_id);
                }

                applyCellValue(cell, value);
            } catch (error) {
                console.error('update_cell error', error);
                cell.classList.add('cell-error');
                setTimeout(() => cell.classList.remove('cell-error'), 2000);
                applyCellValue(cell, cell.dataset.value ?? '');
            } finally {
                cell.classList.remove('cell-saving');
            }
        };

        const handleAddRow = async () => {
            if (!state.columns.length) {
                window.alert('Crie uma coluna antes de adicionar linhas.');
                return;
            }
            if (addRowBtn) {
                addRowBtn.disabled = true;
            }
            try {
                const headers = await getAuthHeaders();
                headers['Content-Type'] = 'application/json';

                const response = await fetch(`${SHEET_API_BASE}add_row/`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({}),
                });

                if (!response.ok) {
                    const detail = await response.text();
                    throw new Error(detail || `Erro ao adicionar linha (status ${response.status})`);
                }

                const data = await response.json();
                const newRow = createRowElement(data.row_id);
                insertRowElement(newRow);
                newRow.querySelector('.sheet-cell')?.focus();
            } catch (error) {
                console.error('add_row error', error);
                window.alert(error.message || 'Erro ao adicionar linha.');
            } finally {
                if (addRowBtn) {
                    addRowBtn.disabled = false;
                }
            }
        };

        const handleAddSubrow = async (rowId, trigger) => {
            if (!state.columns.length) {
                window.alert('Crie uma coluna antes de adicionar linhas.');
                return;
            }
            if (trigger) {
                trigger.disabled = true;
            }
            try {
                const headers = await getAuthHeaders();
                headers['Content-Type'] = 'application/json';

                const response = await fetch(`${SHEET_API_BASE}add_subrow/`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ parent_row_id: rowId }),
                });

                if (!response.ok) {
                    const detail = await response.text();
                    throw new Error(detail || `Erro ao adicionar sublinha (status ${response.status})`);
                }

                const data = await response.json();
                const subRow = createRowElement(data.row_id, { isSubrow: true, parentId: rowId });
                insertRowElement(subRow, rowId);
                subRow.querySelector('.sheet-cell')?.focus();
            } catch (error) {
                console.error('add_subrow error', error);
                window.alert(error.message || 'Erro ao adicionar sublinha.');
            } finally {
                if (trigger) {
                    trigger.disabled = false;
                }
            }
        };

        const handleDeleteRow = async (rowId, trigger) => {
            if (!window.confirm('Tem certeza de que deseja excluir esta linha?')) {
                return;
            }
            if (trigger) {
                trigger.disabled = true;
            }
            try {
                const headers = await getAuthHeaders();
                headers['Content-Type'] = 'application/json';

                const response = await fetch(`${SHEET_API_BASE}remove_row/`, {
                    method: 'DELETE',
                    headers,
                    body: JSON.stringify({ row_id: rowId }),
                });

                if (!response.ok) {
                    const detail = await response.text();
                    throw new Error(detail || `Erro ao excluir linha (status ${response.status})`);
                }

                removeRowAndDescendants(rowId);
            } catch (error) {
                console.error('remove_row error', error);
                window.alert(error.message || 'Erro ao excluir linha.');
            } finally {
                if (trigger) {
                    trigger.disabled = false;
                }
            }
        };

        if (addRowBtn) {
            addRowBtn.disabled = state.columns.length === 0;
            if (!addRowBtn.disabled) {
                addRowBtn.addEventListener('click', handleAddRow);
            }
        }

        if (tbody) {
            tbody.addEventListener('focusin', handleCellFocus);
            tbody.addEventListener('focusout', handleCellBlur);
            tbody.addEventListener('keydown', handleCellKeyDown);

            tbody.addEventListener('click', (event) => {
                const addSubBtn = event.target.closest('.btn-add-subrow');
                if (addSubBtn) {
                    const targetRowId = Number(addSubBtn.dataset.rowId);
                    if (targetRowId) {
                        handleAddSubrow(targetRowId, addSubBtn);
                    }
                    return;
                }

                const deleteBtn = event.target.closest('.btn-delete-row');
                if (deleteBtn) {
                    const targetRowId = Number(deleteBtn.dataset.rowId);
                    if (targetRowId) {
                        handleDeleteRow(targetRowId, deleteBtn);
                    }
                }
            });
        }

        state.columns.forEach(({ element, editable }) => {
            const applyColumnValue = (value) => {
                const normalized = value != null ? String(value).trim() : '';
                element.dataset.value = normalized;
                element.textContent = normalized === '' ? '(Sem nome)' : normalized;
            };

            if (!editable) {
                element.setAttribute('contenteditable', 'false');
                return;
            }

            element.addEventListener('focus', () => {
                element.dataset.originalValue = element.dataset.value ?? element.textContent.trim();
            });

            element.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    element.blur();
                }
            });

            element.addEventListener('blur', async () => {
                const original = (element.dataset.originalValue ?? '').trim();
                delete element.dataset.originalValue;

                const newValue = element.textContent.trim();
                if (newValue === '') {
                    window.alert('O nome da coluna não pode ficar vazio.');
                    applyColumnValue(original);
                    return;
                }
                if (newValue === original) {
                    applyColumnValue(original);
                    return;
                }

                element.classList.add('cell-saving');
                try {
                    const headers = await getAuthHeaders();
                    headers['Content-Type'] = 'application/json';

                    const response = await fetch(`${SHEET_API_BASE}update_column/`, {
                        method: 'PATCH',
                        headers,
                        body: JSON.stringify({ column_id: Number(element.dataset.columnId), nome: newValue }),
                    });

                    if (!response.ok) {
                        const detail = await response.text();
                        throw new Error(detail || `Erro ao renomear coluna (status ${response.status})`);
                    }

                    applyColumnValue(newValue);
                } catch (error) {
                    console.error('update_column error', error);
                    element.classList.add('cell-error');
                    setTimeout(() => element.classList.remove('cell-error'), 2000);
                    applyColumnValue(original);
                } finally {
                    element.classList.remove('cell-saving');
                }
            });
        });
    };

    const initContractsSection = () => {
        const toggleBtn = document.getElementById('toggleAddContract');
        const wrapper = document.getElementById('addContractWrapper');
        const cancelBtn = document.getElementById('cancelAddContract');
        const contractsTable = document.querySelector('.contracts-table');

        const formatCurrency = (value) => {
            const numeric = Number(value);
            if (Number.isNaN(numeric)) {
                return 'R$ 0,00';
            }
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
            }).format(numeric);
        };

        const formatDisplay = (value, type) => {
            if (value === null || value === undefined || value === '') {
                return '-';
            }
            if (type === 'currency') {
                return formatCurrency(value);
            }
            return String(value);
        };

        const parseValue = (text, type) => {
            const trimmed = text.trim();
            if (!trimmed) {
                return '';
            }
            if (type === 'integer') {
                const cleaned = trimmed.replace(/[^0-9-]/g, '');
                const intVal = parseInt(cleaned, 10);
                if (Number.isNaN(intVal)) {
                    throw new Error('Valor invalido');
                }
                return intVal;
            }
            if (type === 'currency') {
                const sanitized = trimmed.replace(/[^0-9,.-]/g, '');
                const withoutThousands = sanitized.replace(/\.(?=\d{3}(\D|$))/g, '');
                const normalized = withoutThousands.replace(/,/g, '.');
                const floatVal = parseFloat(normalized);
                if (Number.isNaN(floatVal)) {
                    throw new Error('Valor invalido');
                }
                return floatVal;
            }
            return trimmed;
        };

        const normalizeValueForDataset = (value, type) => {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            if (type === 'integer') {
                const numeric = Number(value);
                return Number.isNaN(numeric) ? '' : String(Math.trunc(numeric));
            }
            if (type === 'currency') {
                const numeric = Number(value);
                return Number.isNaN(numeric) ? '' : String(numeric);
            }
            return String(value);
        };

        const normalizeForComparison = (value, type) => {
            if (value === null || value === undefined || value === '') {
                return '';
            }
            if (type === 'integer') {
                const numeric = Number(value);
                return Number.isNaN(numeric) ? '' : String(Math.trunc(numeric));
            }
            if (type === 'currency') {
                const numeric = Number(value);
                return Number.isNaN(numeric) ? '' : numeric.toFixed(2);
            }
            return String(value).trim();
        };

        const applyValueToCell = (cell, value) => {
            const type = cell.dataset.type;
            const normalized = normalizeValueForDataset(value, type);
            cell.dataset.value = normalized;

            let displayValue = '';
            if (normalized !== '') {
                if (type === 'integer') {
                    displayValue = Number(parseInt(normalized, 10));
                } else if (type === 'currency') {
                    displayValue = Number(parseFloat(normalized));
                } else {
                    displayValue = normalized;
                }
            }

            const rendered = formatDisplay(displayValue, type);
            cell.textContent = rendered === '' ? '-' : rendered;
        };

        const showError = (cell, message) => {
            cell.classList.add('cell-error');
            cell.setAttribute('title', message);
            setTimeout(() => {
                cell.classList.remove('cell-error');
                cell.removeAttribute('title');
                applyValueToCell(cell, cell.dataset.value);
            }, 2000);
        };

        const updateContratoField = async (cell, contratoId, field, value) => {
            cell.classList.add('cell-saving');
            try {
                const headers = await getAuthHeaders();
                headers['Content-Type'] = 'application/json';

                const response = await fetch(`${CONTRACTS_API_BASE}${contratoId}/`, {
                    method: 'PATCH',
                    headers,
                    body: JSON.stringify({ [field]: value }),
                });

                if (!response.ok) {
                    throw new Error(`Erro ao salvar (status ${response.status})`);
                }

                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    data = {};
                }
                const updatedValue = Object.prototype.hasOwnProperty.call(data, field) ? data[field] : value;
                applyValueToCell(cell, updatedValue);
            } catch (error) {
                showError(cell, error.message || 'Erro ao salvar');
            } finally {
                cell.classList.remove('cell-saving');
            }
        };

        const setupEditableCells = () => {
            if (!contractsTable) {
                return;
            }
            contractsTable.querySelectorAll('.editable-wrapper[data-field]').forEach((cell) => {
                cell.addEventListener('focus', () => {
                    cell.dataset.originalValue = cell.dataset.value ?? '';
                    if ((cell.dataset.value ?? '') === '' && cell.textContent.trim() === '-') {
                        cell.textContent = '';
                    }
                });

                cell.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        cell.blur();
                    }
                });

                cell.addEventListener('blur', async () => {
                    const contratoId = cell.closest('tr')?.dataset?.contratoId;
                    const field = cell.dataset.field;
                    const type = cell.dataset.type;
                    if (!contratoId || !field) {
                        return;
                    }

                    try {
                        if (type !== 'text' && cell.textContent.trim() === '') {
                            applyValueToCell(cell, cell.dataset.value);
                            return;
                        }
                        const parsedValue = parseValue(cell.textContent, type);
                        const normalized = parsedValue === '' ? '' : parsedValue;
                        const originalNormalized = normalizeForComparison(cell.dataset.originalValue ?? '', type);
                        const currentNormalized = normalizeForComparison(normalized, type);
                        if (currentNormalized === originalNormalized) {
                            applyValueToCell(cell, cell.dataset.value);
                            return;
                        }
                        await updateContratoField(cell, contratoId, field, normalized);
                    } catch (error) {
                        showError(cell, error.message || 'Valor invalido');
                    }
                });
            });
        };

        if (toggleBtn && wrapper) {
            const updateAria = () => {
                const expanded = wrapper.classList.contains('active');
                toggleBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            };

            if (wrapper.classList.contains('active')) {
                updateAria();
            }

            toggleBtn.addEventListener('click', () => {
                if (toggleBtn.disabled) {
                    return;
                }
                wrapper.classList.toggle('active');
                updateAria();
            });

            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    wrapper.classList.remove('active');
                    updateAria();
                });
            }
        }

        setupEditableCells();
    };

    document.addEventListener('DOMContentLoaded', () => {
        initSheetSection();
        if (sheetTipo === 'contratos') {
            initContractsSection();
        }
    });
</script>
{% endblock %}
