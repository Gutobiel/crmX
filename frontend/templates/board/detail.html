{% extends 'base.html' %}
{% load static %}

{% block title %}{{ board.nome }} - Pasta{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <style>
        .board-breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #666;
            font-size: 14px;
        }

        .board-breadcrumb a {
            color: #333781;
            text-decoration: none;
        }

        .board-breadcrumb a:hover {
            text-decoration: underline;
        }

        .board-info-card {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .board-title-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e1e5e9;
        }

        .board-title {
            color: #302754;
            font-size: 28px;
            font-weight: 600;
            margin: 0;
        }

        .board-actions {
            display: flex;
            gap: 10px;
        }

        .board-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .meta-label {
            color: #666;
            font-size: 14px;
        }

        .meta-value {
            color: #302754;
            font-size: 16px;
            font-weight: 600;
        }

        .sheets-section {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            color: #302754;
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .sheets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }

        .sheet-card {
            background: #f8f9ff;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            transition: all 0.3s ease;
        }

        .sheet-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 18px rgba(51, 55, 129, 0.12);
            border-color: #333781;
        }

        .sheet-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .sheet-card-title {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #302754;
            line-height: 1.3;
        }

        .sheet-card-type {
            padding: 6px 12px;
            background: #333781;
            color: #fff;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .sheet-card-desc {
            margin: 0;
            font-size: 13px;
            color: #555;
            line-height: 1.5;
            min-height: 48px;
        }

        .sheet-card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7a7a7a;
        }

        .sheet-card-footer {
            display: flex;
            justify-content: flex-end;
        }

        .sheet-card-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 8px;
            background: #333781;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.2s ease;
        }

        .sheet-card-btn:hover {
            background: #252d6e;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 20px;
        }

        .sheet-card-empty {
            text-align: center;
            padding: 50px 20px;
            border: 1px dashed #cfd3e5;
            border-radius: 12px;
            color: #777;
            background: #fafbff;
        }

        /* Audit mode styles for showing delete buttons on sheets */
        .audit-on .sheet-card { padding-bottom: 56px; position: relative; }
        .sheet-delete {
            display: none;
            position: absolute;
            right: 14px;
            bottom: 14px;
            background: #fff;
            border: 1px solid #e1e5e9;
            color: #c62828;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .audit-on .sheet-delete { display: inline-flex; }

        /* Indicador de edição, igual ao título de Workspaces */
        .editable-wrapper {
            display: inline-block;
            position: relative;
            min-width: 200px;
        }

        .editable-wrapper[contenteditable="true"] {
            border-bottom: 2px dashed #333781;
            padding: 0 4px;
            outline: none;
            cursor: text;
        }

        .editable-wrapper[contenteditable="true"]:focus {
            border-bottom: 2px solid #333781;
            background-color: rgba(51, 55, 129, 0.05);
        }

    </style>
{% endblock %}

{% block page_title %}
    {{ workspace.nome }}
{% endblock %}

{% block breadcrumb %}
    <div class="board-breadcrumb">
        <a href="{% url 'workspace' %}"><i class="fas fa-home"></i> Workspaces</a>
        <i class="fas fa-chevron-right"></i>
        <a href="{% url 'workspace_detail' workspace.id %}">{{ workspace.nome }}</a>
        <i class="fas fa-chevron-right"></i>
        <span>{{ board.nome }}</span>
    </div>
{% endblock %}

{% block content %}
    <!-- Board Info -->
    <div class="board-info-card">
        <div class="board-title-section">
            <h1 class="board-title editable-wrapper" contenteditable="true" data-board-id="{{ board.id }}">{{ board.nome }}</h1>
            <div class="board-actions">
                <button class="btn-action" onclick="editBoard()">
                    <i class="fas fa-edit"></i>
                    Editar
                </button>
                <button class="btn-action" style="color: #dc3545;" onclick="deleteBoard()">
                    <i class="fas fa-trash"></i>
                    Excluir
                </button>
            </div>
        </div>

        <div class="board-meta">
            <div class="meta-item">
                <span class="meta-label">Workspace</span>
                <span class="meta-value">{{ workspace.nome }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Criado em</span>
                <span class="meta-value">{{ board.created_at|date:'d/m/Y H:i' }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Última atualização</span>
                <span class="meta-value">{{ board.updated_at|date:'d/m/Y H:i' }}</span>
            </div>
        </div>
    </div>

    <!-- Sheets Section -->
    <div class="sheets-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-table"></i> Planilhas
                <span class="sheet-card-type" style="background:#f0f1f7; color:#333781;">{{ sheets.count }}</span>
            </h2>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="text" id="sheetSearch" placeholder="Pesquisar planilhas..." 
                       style="padding:8px 12px; border:1px solid #e1e5e9; border-radius:8px; font-size:13px;">
                <a class="btn-primary" href="/sheet/tipo/planilha/?board={{ board.id }}" id="btnNewSheet">
                    <i class="fas fa-plus"></i>
                    Nova Planilha
                </a>
                <button id="auditToggleSheets" class="btn-action" title="Habilitar edição/auditoria" style="background:#f4f5f7; color:#333; border:1px solid #e1e5e9; padding:8px 14px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:6px;">
                    <i class="fas fa-shield-alt"></i>
                    Auditoria
                </button>
            </div>
        </div>

        {% if sheets %}
            <div class="sheets-grid">
                {% for sheet in sheets %}
                    <div class="sheet-card">
                        <div class="sheet-card-header">
    <h3 class="sheet-card-title">{{ sheet.nome }}</h3>
    <span class="sheet-card-type">
        {% if sheet.template_type == 'contratos' %}
            Contratos
        {% elif sheet.template_type == 'produtos' %}
            Produtos
        {% elif sheet.template_type == 'colaboradores' %}
            Colaboradores
        {% else %}
            Genérico
        {% endif %}
    </span>
</div>
                        <p class="sheet-card-desc">{{ sheet.descricao|default:"Sem descrição cadastrada." }}</p>
                        <div class="sheet-card-meta">
                            <span>Criada {{ sheet.created_at|date:'d/m/Y' }}</span>
                            <span>Atualizada {{ sheet.updated_at|timesince }} atrás</span>
                        </div>
                        <div class="sheet-card-footer">
                            {% if sheet.template_type == 'contratos' %}
                                <a class="sheet-card-btn" href="{% url 'sheet_contratos_detail' sheet.id %}">
                                    <i class="fas fa-file-contract"></i> Abrir contratos
                                </a>
                            {% elif sheet.template_type == 'produtos' %}
                                <a class="sheet-card-btn" href="{% url 'sheet_produtos_detail' sheet.id %}">
                                    <i class="fas fa-boxes"></i> Abrir produtos
                                </a>
                            {% elif sheet.template_type == 'colaboradores' %}
                                <a class="sheet-card-btn" href="{% url 'sheet_colaboradores_detail' sheet.id %}">
                                    <i class="fas fa-user-friends"></i> Abrir colaboradores
                                </a>
                            {% else %}
                                <a class="sheet-card-btn" href="{% url 'sheet_detail' sheet.id %}">
                                    <i class="fas fa-file-alt"></i> Abrir planilha
                                </a>
                            {% endif %}
                        </div>
                        <button class="sheet-delete" data-sheet-id="{{ sheet.id }}" title="Excluir planilha"><i class="fas fa-trash"></i> Excluir</button>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="sheet-card-empty">
                <i class="fas fa-table" style="font-size:36px; margin-bottom:12px;"></i>
                <p>Nenhuma planilha criada nesta pasta.</p>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Funções globais (fora do módulo para acessar via onclick)
    window.openSheet = function(sheetId) {
        console.log('Opening sheet:', sheetId);
        window.location.href = `/sheet/${sheetId}/`;
    };

    window.createSheet = function() {
        const boardId = parseInt('{{ board.id }}', 10);
        window.location.assign(`/sheet/new/?board=${boardId}`);
    };

    window.editBoard = function() {
        alert('Para editar o título da pasta basta clicar diretamente nela e renomear.');
    };

    window.shareBoard = function() {
        alert('Funcionalidade de compartilhamento será implementada');
    };

    window.deleteBoard = async function() {
        const workspaceId = parseInt('{{ workspace.id }}', 10);
        const boardId = parseInt('{{ board.id }}', 10);
        
        if (!confirm('Tem certeza que deseja excluir esta pasta? Esta ação não pode ser desfeita.')) {
            return;
        }

        try {
            const { getAuthHeaders } = await import('{% static "js/api/auth.js" %}');
            const headers = await getAuthHeaders();
            const response = await fetch(`/api/v1/board/${boardId}/`, {
                method: 'DELETE',
                headers
            });

            if (!response.ok) throw new Error('Failed to delete board');

            alert('Pasta excluída com sucesso!');
            window.location.href = `/workspace/${workspaceId}/boards/`;
        } catch (error) {
            console.error('Error deleting board:', error);
            alert('Erro ao excluir pasta');
        }
    };

    // Pesquisa de planilhas por nome
    (function(){
        const searchInput = document.getElementById('sheetSearch');
        const cards = Array.from(document.querySelectorAll('.sheet-card'));
        const getTitle = (card) => card.querySelector('.sheet-card-title')?.textContent.trim().toLowerCase() || '';
        searchInput?.addEventListener('input', function(){
            const q = this.value.trim().toLowerCase();
            cards.forEach(card => {
                const match = getTitle(card).includes(q);
                card.style.display = match ? '' : 'none';
            });
        });
    })();

    // Fallback: carrega planilhas via API apenas deste board quando não renderizadas server-side
    (async function(){
        const grid = document.querySelector('.sheets-grid');
        const empty = document.querySelector('.sheet-card-empty');
        // Se já temos cards renderizados no server, não faz fallback
        if (grid && grid.querySelector('.sheet-card')) return;
        try {
            const { getAuthHeaders } = await import('{% static "js/api/auth.js" %}');
            const headers = await getAuthHeaders();
            const boardId = parseInt('{{ board.id }}', 10);
            const res = await fetch(`/api/v1/sheet/?board=${boardId}`, { headers });
            if (!res.ok) return;
            const data = await res.json();
            if (!Array.isArray(data) || data.length === 0) return;
            // criar grid se não existir
            let targetGrid = grid;
            if (!targetGrid) {
                targetGrid = document.createElement('div');
                targetGrid.className = 'sheets-grid';
                empty?.insertAdjacentElement('beforebegin', targetGrid);
                empty?.remove();
            }
            targetGrid.innerHTML = data.map(s => `
                <div class="sheet-card">
                    <div class="sheet-card-header">
                        <h3 class="sheet-card-title">${sheet.nome || 'Sem nome'}</h3>
                    </div>
                    <p class="sheet-card-desc">${sheet.descricao || 'Sem descrição cadastrada.'}</p>
                    <div class="sheet-card-meta">
                        <span>Criada ${(s.created_at || '').slice(0,10)}</span>
                        <span>Atualizada ${(s.updated_at || '').slice(0,10)}</span>
                    </div>
                    <div class="sheet-card-footer">
                        ${
                            s.template_type === 'contratos'
                                ? `<a class=\"sheet-card-btn\" href=\"/sheet/${s.id}/contratos/\"><i class=\\\"fas fa-file-contract\\\"></i> Abrir contratos</a>`
                                : s.template_type === 'produtos'
                                    ? `<a class=\"sheet-card-btn\" href=\"/sheet/${s.id}/produtos/\"><i class=\\\"fas fa-boxes\\\"></i> Abrir produtos</a>`
                                    : s.template_type === 'colaboradores'
                                        ? `<a class=\"sheet-card-btn\" href=\"/sheet/${s.id}/colaboradores/\"><i class=\\\"fas fa-user-friends\\\"></i> Abrir colaboradores</a>`
                                        : `<a class=\"sheet-card-btn\" href=\"/sheet/${s.id}/\"><i class=\\\"fas fa-file-alt\\\"></i> Abrir planilha</a>`
                        }
                    </div>
                    <button class="sheet-delete" data-sheet-id="${s.id}" title="Excluir planilha"><i class=\"fas fa-trash\"></i> Excluir</button>
                </div>
            `).join('');
        } catch(e) {
            console.warn('Falha ao carregar planilhas via API', e);
        }
    })();

    // Edição inline do título (editable-wrapper)
    (function(){
        const titleEl = document.querySelector('.editable-wrapper');
        if (!titleEl) return;
        const boardId = parseInt(titleEl.getAttribute('data-board-id') || '{{ board.id }}', 10);
        let originalText = titleEl.textContent.trim();

        const updateBreadcrumb = (newName) => {
            const crumb = document.querySelector('.board-breadcrumb span:last-child');
            if (crumb) crumb.textContent = newName;
        };

        const updateDocumentTitle = (newName) => {
            try { document.title = `${newName} - Pasta`; } catch (_) {}
        };

        titleEl.addEventListener('focus', () => {
            originalText = titleEl.textContent.trim();
        });

        titleEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                titleEl.blur();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                titleEl.textContent = originalText;
                titleEl.blur();
            }
        });

        titleEl.addEventListener('blur', async () => {
            const newName = titleEl.textContent.trim();
            if (newName === '') {
                titleEl.textContent = originalText; // evita nome vazio
                return;
            }
            if (newName === originalText) return; // nada mudou

            try {
                const { getAuthHeaders } = await import('{% static "js/api/auth.js" %}');
                const headers = await getAuthHeaders();
                headers['Content-Type'] = 'application/json';

                const res = await fetch(`/api/v1/board/${boardId}/`, {
                    method: 'PATCH',
                    headers,
                    body: JSON.stringify({ nome: newName })
                });

                if (!res.ok) throw new Error('Falha ao atualizar nome');

                originalText = newName;
                updateBreadcrumb(newName);
                updateDocumentTitle(newName);
            } catch (err) {
                console.error('Erro ao salvar título do board:', err);
                alert('Não foi possível salvar o novo título.');
                titleEl.textContent = originalText; // reverte
            }
        });
    })();

    // Auditoria: mostrar/ocultar botões de excluir planilhas e executar exclusão
    (function(){
        const section = document.querySelector('.sheets-section');
        const toggle = document.getElementById('auditToggleSheets');
        if (!section || !toggle) return;
        let auditOn = false;

        toggle.addEventListener('click', () => {
            auditOn = !auditOn;
            toggle.classList.toggle('active', auditOn);
            toggle.innerHTML = auditOn ? '<i class="fas fa-shield-alt"></i> Auditoria ON' : '<i class="fas fa-shield-alt"></i> Auditoria';
            section.classList.toggle('audit-on', auditOn);
        });

        section.addEventListener('click', async (e) => {
            const btn = e.target.closest('.sheet-delete');
            if (!btn) return;
            const sheetId = btn.getAttribute('data-sheet-id');
            if (!sheetId) return;
            if (!confirm('Tem certeza que deseja excluir esta planilha? Esta ação é permanente.')) return;
            try {
                const { getAuthHeaders } = await import('{% static "js/api/auth.js" %}');
                const headers = await getAuthHeaders();
                headers['Accept'] = 'application/json';
                const resp = await fetch(`/api/v1/sheet/${sheetId}/`, { method: 'DELETE', headers });
                if (resp.status === 204 || resp.status === 200) {
                    const card = btn.closest('.sheet-card');
                    card?.remove();
                } else {
                    const txt = await resp.text();
                    console.error('Delete sheet failed:', txt);
                    alert('Falha ao excluir planilha.');
                }
            } catch(err) {
                console.error('Erro ao excluir planilha', err);
                alert('Erro de rede ao excluir.');
            }
        });
    })();
</script>
{% endblock %}
