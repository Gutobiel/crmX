
<!-- Aqui temos todas as pastas (boards) criadas dentro desta area de trabalho   -->
<!-- Botão apagar area de trabalho (avisar que esta ação apagara todos os dados incluidos nele) -->
<!-- Renomear area de trabalho(Titulo) -->

<!-- Participantes e membros -->
<!-- Adicionar membro, retirar, compatilhar -->



{% extends 'base.html' %}
{% load static %}

{% block title %}Áreas de Trabalho{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <style>
        .editable-wrapper {
            display: inline-block;
            position: relative;
            min-width: 200px;
        }

        .editable-wrapper[contenteditable="true"] {
            border-bottom: 2px dashed #333781;
            padding: 0 4px;
            outline: none;
        }

        .editable-wrapper[contenteditable="true"]:focus {
            border-bottom: 2px solid #333781;
            background-color: rgba(51, 55, 129, 0.05);
        }

        .workspace-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .workspace-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #e1e5e9;
            position: relative; /* permite posicionar botão de exclusão */
        }

        .workspace-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .workspace-title {
            color: #302754;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .workspace-menu {
            color: #666;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .workspace-menu:hover {
            background: #f4f5f7;
            color: #333781;
        }

        .workspace-stats {
            display: flex;
            gap: 15px;
            color: #666;
            font-size: 14px;
        }

        .workspace-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .workspace-members {
            margin-top: 15px;
            display: flex;
            align-items: center;
        }

        .member-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #333781;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-right: -8px;
            border: 2px solid white;
        }

        .more-members {
            background: #f4f5f7;
            color: #666;
        }

        .btn-filter.active {
            background: #333781;
            color: white;
        }
        .toolbar { display:flex; justify-content:space-between; align-items:center; }
        .toolbar-right { display:flex; gap:10px; }
    .btn-action.btn-audit { background:#f4f5f7; color:#333; border:1px solid #e1e5e9; padding:8px 14px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:6px; }
        .btn-action.btn-audit.active { background:#333781; color:#fff; }
        .workspace-header-actions { display:flex; gap:8px; align-items:center; }
    .btn-delete { background:#fff; border:1px solid #e1e5e9; color:#c62828; padding:6px 10px; border-radius:6px; cursor:pointer; display:none; align-items:center; gap:4px; transition:.2s; position:absolute; bottom:12px; right:12px; box-shadow:0 2px 4px rgba(0,0,0,0.08); }
    .audit-on .btn-delete { display:flex; }
    .workspace-card.audit-on { padding-bottom:60px; } /* espaço extra para botão não sobrepor conteúdo */
        .btn-delete:hover { background:#ffecec; }
        .audit-hint { font-size:12px; color:#c62828; margin-top:4px; display:none; }
    </style>
{% endblock %}

{% block page_title %}
    <div class="" id="workspaceTitle">
        Áreas de Trabalho
    </div>
{% endblock %}

{% block content %}
    <!-- Board Header -->
    <div class="board-header">
        <div class="board-title">
            <div class="board-actions">
                <button class="btn-action" id="filterBtn">
                    <i class="fas fa-filter"></i>
                    Filtrar
                </button>
                <button class="btn-action" id="exportBtn">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
                <a href="{% url 'new_workspace' %}" class="btn-primary" id="newWorkspaceBtn" title="Nova Área de Trabalho">
                        <i class="fas fa-plus"></i>
                        Nova Área de Trabalho
                    </a>
            </div>
        </div>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
        <div class="toolbar-left">
            <button class="btn-filter active" data-filter="my-folders">
                <i class="fas fa-folder"></i>
                Minhas áreas de trabalho
            </button>
            <button class="btn-filter" data-filter="shared">
                <i class="fas fa-share-alt"></i>
                Compartilhadas Comigo
            </button>
        </div>
        <div class="toolbar-right">
            <button id="auditToggle" class="btn-action btn-audit" title="Habilitar edição/auditoria">
                <i class="fas fa-shield-alt"></i>
                Auditoria
            </button>
        </div>
    </div>

    <!-- Grid de Áreas de Trabalho - carregado via API -->
    <div id="currentUser" data-id="{{ current_user_id|default:0 }}" style="display:none;"></div>
    <div id="workspacesContainer" class="workspace-grid"></div>
    <div id="emptyState" style="display:none; padding:20px; color:#666;">Nenhuma área de trabalho encontrada.</div>
    
{% endblock %}


{% block extra_js %}
<script type="module">
    import { auth } from '/static/js/api/auth.js';

    const API_URL = '/api/v1/workspace/';
    const currentUserId = document.getElementById('currentUser').dataset.id; // usuário atual obtido de atributo data
    const container = document.getElementById('workspacesContainer');
    const emptyState = document.getElementById('emptyState');
    const filterButtons = document.querySelectorAll('.btn-filter');
    const auditToggle = document.getElementById('auditToggle');
    let allWorkspaces = [];
    let activeFilter = 'my-folders';
    let auditMode = false;

    document.addEventListener('DOMContentLoaded', () => {
        fetchWorkspaces();
        setupFilters();
        setupAuditToggle();
        setupDeleteDelegation();
    });

    function setupFilters() {
        filterButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                filterButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                activeFilter = btn.dataset.filter;
                render();
            });
        });
    }

    async function fetchWorkspaces(rql = '') {
        try {
            const url = rql ? `${API_URL}?${rql}` : API_URL;
            const resp = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${auth.getAccessToken()}`,
                    'Accept': 'application/json'
                }
            });
            if (!resp.ok) throw new Error('Falha ao carregar workspaces');
            allWorkspaces = await resp.json();
            render();
        } catch (e) {
            console.error('Erro carregando workspaces:', e);
            container.innerHTML = '<div style="color:#c00;">Erro ao carregar áreas de trabalho.</div>';
        }
    }

    function render() {
        container.innerHTML = '';
        let data = [...allWorkspaces];

        if (activeFilter === 'my-folders') {
            data = data.filter(ws => String(ws.dono) === String(currentUserId));
        } else if (activeFilter === 'shared') {
            data = data.filter(ws => String(ws.dono) !== String(currentUserId));
        }

        if (!data.length) {
            emptyState.style.display = 'block';
            return;
        }
        emptyState.style.display = 'none';

        data.forEach(ws => container.appendChild(buildCard(ws)));
    }

    function buildCard(ws) {
        const card = document.createElement('div');
        card.className = 'workspace-card';
        const isOwner = String(ws.dono) === String(currentUserId);
        const badge = isOwner
            ? '<span class="badge" style="margin-left:8px; background:#e6f4ea; color:#1e7e34; padding:2px 8px; border-radius:12px; font-size:12px;">Proprietário</span>'
            : '<span class="badge" style="margin-left:8px; background:#e8f0fe; color:#1a73e8; padding:2px 8px; border-radius:12px; font-size:12px;">Compartilhado</span>';

        const members = Array.isArray(ws.membros) ? ws.membros : [];
        const memberAvatars = members.slice(0,3).map(avatarHtml).join('');
        const extra = members.length > 3 ? `<div class="member-avatar more-members" title="Mais membros">+${members.length - 3}</div>` : '';

        card.innerHTML = `
            <div class="workspace-header">
                <h3 class="workspace-title">${escapeHtml(ws.nome || '')} ${badge}</h3>
                <div class="workspace-header-actions">
                    <a class="btn-primary" href="/workspace/${ws.id}/" title="Acessar"><i class="fas fa-arrow-right"></i> Acessar</a>
                    ${isOwner ? `<button class="btn-delete" data-id="${ws.id}" title="Excluir"><i class="fas fa-trash"></i></button>` : ''}
                </div>
            </div>
            <div class="workspace-stats">
                <div class="workspace-stat"><i class="fas fa-folder"></i><span>- pastas</span></div>
                <div class="workspace-stat"><i class="fas fa-users"></i><span>${members.length} membros</span></div>
            </div>
            <div class="workspace-members">${memberAvatars}${extra}</div>
        `;
        if (auditMode) card.classList.add('audit-on');
        return card;
    }

    function avatarHtml(memberId) {
        // Sem lookup de usuário, usa marcador
        const initial = typeof memberId === 'number' ? '#' : String(memberId).charAt(0).toUpperCase();
        return `<div class="member-avatar" title="Membro">${initial}</div>`;
    }

    function escapeHtml(str) {
        return String(str).replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    function setupAuditToggle() {
        auditToggle.addEventListener('click', () => {
            auditMode = !auditMode;
            auditToggle.classList.toggle('active', auditMode);
            auditToggle.innerHTML = auditMode 
                ? '<i class="fas fa-shield-alt"></i> Auditoria ON'
                : '<i class="fas fa-shield-alt"></i> Auditoria';
            // Re-render to show/hide delete buttons
            render();
        });
    }

    function setupDeleteDelegation() {
        container.addEventListener('click', (e) => {
            const btn = e.target.closest('.btn-delete');
            if (!btn) return;
            const id = btn.getAttribute('data-id');
            handleDelete(id, btn);
        });
    }

    async function handleDelete(id, btn) {
        if (!auditMode) return; // safety
        if (!confirm('Tem certeza que deseja excluir esta área de trabalho? Esta ação é permanente.')) return;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        try {
            const resp = await fetch(`/api/v1/workspace/${id}/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${auth.getAccessToken()}`,
                    'Accept': 'application/json'
                }
            });
            if (resp.status === 204 || resp.status === 200) {
                // Remove from local array and re-render
                allWorkspaces = allWorkspaces.filter(w => String(w.id) !== String(id));
                render();
            } else {
                const txt = await resp.text();
                alert('Falha ao excluir: ' + txt);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash"></i>';
            }
        } catch (err) {
            console.error('Erro ao excluir workspace', err);
            alert('Erro de rede ao excluir.');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash"></i>';
        }
    }
</script>
{% endblock %}